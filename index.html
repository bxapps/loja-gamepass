<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GlobalCCC Store | Login Real</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* --- ESTILOS VISUAIS (Mantendo identidade) --- */
        :root {
            --bg-body: #0b1116; --bg-card: #161f28; --primary: #6f42c1;
            --text-main: #edf2f7; --text-sec: #a0aec0; --border: #2d3748;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; }
        
        .hidden { display: none !important; }
        .btn { padding: 12px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; width: 100%; margin-top: 10px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: #5a32a3; }
        .btn-link { background: none; color: var(--primary); margin-top: 15px; font-size: 12px; text-decoration: underline; }

        /* TELA DE AUTH */
        #auth-screen { display: flex; align-items: center; justify-content: center; height: 100vh; }
        .auth-box { background: var(--bg-card); padding: 40px; border-radius: 12px; border: 1px solid var(--border); width: 100%; max-width: 400px; text-align: center; }
        .auth-input { width: 100%; background: var(--bg-body); border: 1px solid var(--border); padding: 12px; color: white; border-radius: 6px; margin-bottom: 10px; }
        
        /* HEADER DO APP */
        header { background: var(--bg-card); padding: 15px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .user-email { font-size: 12px; color: var(--text-sec); margin-right: 10px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div id="login-form" class="auth-box">
            <h2 style="margin-bottom: 20px;">Acessar Loja</h2>
            <input type="email" id="login-email" class="auth-input" placeholder="Seu E-mail">
            <input type="password" id="login-pass" class="auth-input" placeholder="Sua Senha">
            <button class="btn btn-primary" id="btnLogin">ENTRAR</button>
            <button class="btn btn-link" onclick="toggleAuth('register')">Não tem conta? Crie agora</button>
        </div>

        <div id="register-form" class="auth-box hidden">
            <h2 style="margin-bottom: 20px;">Criar Nova Conta</h2>
            <input type="email" id="reg-email" class="auth-input" placeholder="Seu melhor E-mail">
            <input type="password" id="reg-pass" class="auth-input" placeholder="Crie uma senha (min 6 digitos)">
            <button class="btn btn-primary" id="btnRegister">CRIAR CONTA</button>
            <button class="btn btn-link" onclick="toggleAuth('login')">Já tenho conta. Fazer Login</button>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <header>
            <div style="font-weight: 800; color: var(--primary);">GLOBAL<span style="color:white">CCC</span></div>
            <div style="display:flex; align-items:center;">
                <span id="display-email" class="user-email">usuario@email.com</span>
                <button onclick="logout()" style="background:#e53e3e; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Sair</button>
            </div>
        </header>

        <div style="padding: 40px; text-align: center;">
            <h1>Bem-vindo à Loja!</h1>
            <p style="color: var(--text-sec); margin-top: 10px;">Aqui entraria o catálogo e o chat...</p>
        </div>
    </div>

    <script type="module">
        // 1. IMPORTANDO AS FUNÇÕES DO FIREBASE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        // Novas importações do Firestore
        import { getFirestore, collection, addDoc, query, where, onSnapshot, updateDoc, doc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. COLE AQUI SUA CONFIGURAÇÃO (COPIADA DO CONSOLE DO FIREBASE)
        // Substitua tudo dentro das chaves abaixo:
        const firebaseConfig = {
            apiKey: "AIzaSyAy0Eq6Xk3224bByT7xk96pI__oo2NMC1s",
            authDomain: "globalccc-6df95.firebaseapp.com",
            projectId: "globalccc-6df95",
            storageBucket: "globalccc-6df95.firebasestorage.app",
            messagingSenderId: "73583982316",
            appId: "1:73583982316:web:e343f84908fa58f719d7c9"
        };

       // Inicializa Apps
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app); // Inicializa o Banco

        // Variáveis Globais
        let currentUser = null;
        let unsubscribePedidos = null; // Para parar de ouvir atualizações quando deslogar
        let pedidoAtualId = null; // Para saber qual chat está aberto

        // --- AUTENTICAÇÃO (Igual ao anterior) ---
        document.getElementById('btnRegister').addEventListener('click', () => {
            const email = document.getElementById('reg-email').value;
            const pass = document.getElementById('reg-pass').value;
            createUserWithEmailAndPassword(auth, email, pass).catch(erro => alert(erro.message));
        });

        document.getElementById('btnLogin').addEventListener('click', () => {
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-pass').value;
            signInWithEmailAndPassword(auth, email, pass).catch(erro => alert("Erro ao entrar: " + erro.message));
        });

        window.logout = function() { signOut(auth); }
        window.toggleAuth = function(screen) {
            document.getElementById('login-form').classList.toggle('hidden');
            document.getElementById('register-form').classList.toggle('hidden');
        }

        // --- OBSERVADOR DE LOGIN (AQUI A MÁGICA ACONTECE) ---
        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                // Usuário Logou
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-screen').classList.remove('hidden');
                document.getElementById('display-email').innerText = user.email;
                
                // Começar a "escutar" os pedidos desse usuário em tempo real
                iniciarEscutaDePedidos(user.uid);
            } else {
                // Usuário Saiu
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-screen').classList.add('hidden');
                
                // Para de escutar o banco para economizar dados
                if(unsubscribePedidos) unsubscribePedidos();
                document.getElementById('order-list').innerHTML = '';
            }
        });

        // --- FUNÇÕES DO BANCO DE DADOS (FIRESTORE) ---

        // 1. OUVIR PEDIDOS EM TEMPO REAL
        function iniciarEscutaDePedidos(uid) {
            // Busca na coleção 'pedidos' onde o campo 'uid_cliente' é igual ao ID do usuário logado
            const q = query(collection(db, "pedidos"), where("uid_cliente", "==", uid));

            // onSnapshot roda toda vez que algo muda no banco (tempo real)
            unsubscribePedidos = onSnapshot(q, (querySnapshot) => {
                const lista = document.getElementById('order-list');
                lista.innerHTML = ''; // Limpa lista visual

                if (querySnapshot.empty) {
                    lista.innerHTML = '<p style="padding:20px; text-align:center; color:#a0aec0;">Nenhuma compra.</p>';
                }

                querySnapshot.forEach((doc) => {
                    const pedido = doc.data();
                    const div = document.createElement('div');
                    div.className = 'order-item';
                    // Se este for o pedido aberto no chat, marca como ativo visualmente
                    if(doc.id === pedidoAtualId) div.style.background = "rgba(111, 66, 193, 0.1)";
                    
                    div.innerHTML = `
                        <div style="font-weight: bold;">${pedido.produto}</div>
                        <div style="font-size: 10px; color: #a0aec0;">ID: ${doc.id.substr(0,5)}...</div>
                        <div style="font-size: 10px; color: #38a169;">STATUS: ${pedido.status.toUpperCase()}</div>
                    `;
                    
                    // Ao clicar, abre o chat desse pedido
                    div.onclick = () => carregarChat(doc.id, pedido);
                    lista.appendChild(div);
                    
                    // Se o chat estiver aberto, atualiza as mensagens dele em tempo real também
                    if(doc.id === pedidoAtualId) {
                        renderizarMensagensChat(pedido.mensagens || []);
                    }
                });
            });
        }

        // 2. SALVAR NOVO PEDIDO (SIMULAÇÃO DE COMPRA)
        window.iniciarCompra = function(nomeProduto, valor) {
            // Guarda dados na memória temporária para o modal
            window.tempProduto = { nome: nomeProduto, valor: valor };
            document.getElementById('payment-modal').classList.remove('hidden');
        }

        window.fecharModal = function() {
            document.getElementById('payment-modal').classList.add('hidden');
        }

        window.confirmarPagamentoSimulado = async function() {
            if(!currentUser) return alert("Erro: Você não está logado!");

            const produto = window.tempProduto;
            
            try {
                // CRIA O DOCUMENTO NO FIRESTORE
                await addDoc(collection(db, "pedidos"), {
                    uid_cliente: currentUser.uid,
                    email_cliente: currentUser.email,
                    produto: produto.nome,
                    valor: produto.valor,
                    status: 'pago', // Em produção, isso viria do Webhook do Mercado Pago
                    data_criacao: serverTimestamp(),
                    mensagens: [
                        { tipo: 'system', texto: 'Pagamento iniciado. Aguardando vendedor.', data: new Date().toISOString() }
                    ]
                });

                alert("Compra realizada com sucesso! Verifique a aba 'Minhas Compras'.");
                fecharModal();
                showChat(); // Leva o usuário pra tela de chat
            } catch (e) {
                console.error("Erro ao salvar:", e);
                alert("Erro ao processar compra: " + e.message);
            }
        }

        // --- FUNÇÕES DE CHAT ---

        function carregarChat(docId, dadosPedido) {
            pedidoAtualId = docId;
            document.getElementById('chat-window').classList.remove('hidden');
            document.getElementById('chat-title').innerText = `${dadosPedido.produto}`;
            renderizarMensagensChat(dadosPedido.mensagens || []);
        }

        function renderizarMensagensChat(msgs) {
            const areaMsg = document.getElementById('chat-msgs');
            areaMsg.innerHTML = '';
            
            msgs.forEach(msg => {
                const div = document.createElement('div');
                div.className = `message msg-${msg.tipo}`;
                div.innerText = msg.texto;
                areaMsg.appendChild(div);
            });
            areaMsg.scrollTop = areaMsg.scrollHeight;
        }

        window.enviarMensagem = async function() {
            const input = document.getElementById('msg-input');
            const texto = input.value;
            if(!texto || !pedidoAtualId) return;

            // Atualiza o documento no banco adicionando a nova mensagem ao array
            const pedidoRef = doc(db, "pedidos", pedidoAtualId);

            try {
                await updateDoc(pedidoRef, {
                    mensagens: arrayUnion({
                        tipo: 'user',
                        texto: texto,
                        data: new Date().toISOString()
                    })
                });
                input.value = ''; // Limpa campo
            } catch (e) {
                console.error("Erro ao enviar msg:", e);
            }
        }

        // --- NAVEGAÇÃO ENTRE TELAS ---
        window.showStore = function() {
            document.getElementById('store-area').classList.remove('hidden');
            document.getElementById('chat-area').classList.add('hidden');
        }
        window.showChat = function() {
            document.getElementById('store-area').classList.add('hidden');
            document.getElementById('chat-area').classList.remove('hidden');
        }
    </script>
</body>
</html>
